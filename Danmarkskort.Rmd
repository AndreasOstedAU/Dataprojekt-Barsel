---
title: "Danmarkskort"
author: "Andreas"
date: "4/3/2022"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(sf)
library(rgdal)
library(readxl)
library(viridis)
```

Fra https://www.linkedin.com/pulse/easy-maps-denmark-r-mikkel-freltoft-krogsholm/

# Kort data
Data for landsdele:
```{r}
url = "https://api.dataforsyningen.dk/landsdele?format=geojson"
geofile = tempfile()
download.file(url, geofile)

geodata <- rgdal::readOGR(geofile, use_iconv = TRUE, encoding = 'UTF-8') #skriv geodata@data for at få en data frame
```

Data for kommuner: 
```{r}
url2 <- "https://api.dataforsyningen.dk/kommuner?format=geojson"
geofile2 = tempfile()
download.file(url2, geofile2)

geodata_komm <- rgdal::readOGR(geofile2, use_iconv = TRUE, encoding = 'UTF-8')
```


## Gns udd. landsdele
```{r}
udd_gns_2019 <- read_rds("Data/udd_gns_2019.rds") %>% 
  mutate(Landsdel = str_remove_all(string = Landsdel, pattern = "Landsdel")) %>%  #fjerner "Landsdel" fra navnene
  rename(gns_udd_score = gns) %>% arrange(desc(Landsdel))
udd_gns_2019
```

Man kan ikke joine eks. udd_gns_2019 og geodata@data af uvisse årsager. 
ggplotdata er det som ggplot kan læse som et kort. Det er dog nødvendigt at der ikke er lavet om på rækkefølgen af rækkerne i geodata@data. 
Hvis der er det, passer navnene på landsdelene ikke længere. 

I ggplotdata kan man godt lave om på rækkefølgen af rækkerne. Derfor har jeg sorteret "navn" (landsdel) efter faldende, og gjort det samme i udd_gns_2019. Så kan der tilføjes søjlen med gns. udd. for hver landsdel, ved blot at 'indsætte' den med mutate. 

## Gns Alder for førstegangsfødende kommunalt niv., deciler kommunalt niv.:
```{r}
kommune_alder_børn <- read_excel("Data/kommune_alderbørn_2019.xlsx") %>% filter(!Kommune == 'Christiansø') 
deciler_kommuner <- read_excel("Data/deciler_kommuner_2019.xlsx")
mk_kommuner <- read_excel("Data/mænd_kvinder_kommune_2019.xlsx") %>% mutate(Relativ_forskel_mk = (Mænd-Kvinder)/(Mænd + Kvinder)*100) %>% select(Kommune, Relativ_forskel_mk)

geodata_komm2 <- geodata_komm

geodata_komm2@data <- geodata_komm2@data %>% as_tibble() %>% 
  left_join(kommune_alder_børn, by = c("navn" = "Kommune")) %>% 
  left_join(deciler_kommuner, by = c("navn" = "Kommune")) %>% 
  left_join(mk_kommuner, by = c("navn" = "Kommune"))

geodata_komm2@data
```

```{r}
ggplotdata = sf::st_as_sf(geodata) #landsdele
ggplotdata_komm = sf::st_as_sf(geodata_komm2) #kommuner 

ggplotdata2 <- data.frame(ggplotdata) %>% arrange(desc(navn)) %>% mutate(udd_gns = udd_gns_2019$gns_udd_score)
ggplotdata2
```
Metode som virker uden at indsætte ekstra data i geodata:

```{r}
ggplot(ggplotdata, aes(fill = navn)) +
  geom_sf() +
  theme_minimal()
```

Alternativ metode, som beskrevet:

```{r}
ggplot(ggplotdata2$geometry, aes(fill = ggplotdata2$navn)) +
  geom_sf() +
  theme_minimal() +
  labs(fill = "Landsdel")
```


```{r}
plot_udd <- ggplot(ggplotdata2$geometry, aes(fill = ggplotdata2$udd_gns)) +
  geom_sf() +
  theme_void() +
  labs(fill = "Gennemsnitligt uddannelsesniveau \n(score)\n") +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    legend.title = element_text(size = 8),
    legend.text = element_text(size = 8),
    legend.margin = margin(r=2),
    legend.position = c(1.05, 0.55),
    plot.margin = unit(c(0,2,0,0), 'cm')) +
  scale_fill_gradient(low = 'grey94', high = 'deepskyblue2')

plot_udd
ggsave("Data/uddgns.png", plot = plot_udd)
```

## Forskel i antal mænd og kvinder for landsdele

Lav relativ forskel.
```{r}
køn_landsdele_2019 <- read_rds("Data/køn_landsdele_2019.rds")
køn_landsdele_2019 <- køn_landsdele_2019 %>% mutate(Relativ_forskel = ((Mænd - Kvinder)/(Mænd + Kvinder))*100,
                                                    Landsdel = str_remove_all(string = Landsdel, pattern = "Landsdel")) %>% 
  arrange(desc(Landsdel))
køn_landsdele_2019
```

```{r}
ggplotdata2 <- ggplotdata2 %>% mutate(Diff_køn_relativ = køn_landsdele_2019$Relativ_forskel)
ggplotdata2
```

```{r}
ggplot(ggplotdata2$geometry, aes(fill = ggplotdata2$Diff_køn_relativ)) +
  geom_sf() +
  theme_void() +
  #scale_fill_viridis(option = "viridis", direction = 1, alpha = 0.75, begin = 0.15, end = 0.95) +
  #scale_fill_gradientn(colors = (cm.colors(100, rev = TRUE, alpha = 0.75)), limit = c(-2.75, 2.75)) +
  scale_fill_gradient(low = 'firebrick1', high = 'dodgerblue2',limit = c(-3, 3), labels = c('-3    (Flest kvinder)', '-2', '-1', '0', '1', '2', '3   (Flest mænd)')) +
  labs(fill = "Antal mænd - antal kvinder, \nforskel i procent\n") +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    legend.title = element_text(size = 8),
    legend.text = element_text(size = 8),
    legend.margin = margin(r=2),
    legend.position = c(1.025, 0.55),
    plot.margin = unit(c(0,2,0,0), 'cm'))
```
## Forskel i antal mænd og kvinder for kommuner

```{r}

ggplot(ggplotdata_komm, aes(fill = Relativ_forskel_mk)) +
  geom_sf() +
  theme_void() +
  scale_fill_gradient(low = 'firebrick1', high = 'dodgerblue2',limit = c(-5, 5), labels = c('-5    (Flest kvinder)', '-2.5', '0', '2.5', '5    (Flest mænd)')) +
  labs(fill = "Antal mænd - antal kvinder, \nforskel i procent\n") +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    legend.title = element_text(size = 8),
    legend.text = element_text(size = 8),
    legend.margin = margin(r=2),
    legend.position = c(1.025, 0.55),
    plot.margin = unit(c(0,2,0,0), 'cm'))

```


# Gennemsnitsindkomst landsdele

```{r}
gnsindkomst_landsdele_2019 <- read_rds("Data/gns_indkomst_landsdele_2019.rds")
gnsindkomst_landsdele_2019 <- gnsindkomst_landsdele_2019 %>% mutate(Landsdel = str_remove_all(string = Landsdel, pattern = "Landsdel")) %>% 
  arrange(desc(Landsdel))
gnsindkomst_landsdele_2019

ggplotdata2 <- ggplotdata2 %>% mutate(Gns_indkomst = gnsindkomst_landsdele_2019$Gns_indkomst)
```

```{r}
ggplot(ggplotdata2$geometry, aes(fill = ggplotdata2$Gns_indkomst)) +
  geom_sf() +
  theme_void() +
  labs(fill = "Gns. indkomst") +
  theme(
  axis.text.x = element_blank(),
  axis.text.y = element_blank(),
  axis.ticks = element_blank())
```

Til medianindkomst (eller deciler) kan IFOR22 eller IFOR32 muligvis anvendes. 

## Q10, Q50 og Q90 for landsdele (IFOR22)

```{r}
deciler_landsdele <- read_rds("Data/deciler_landsdel_2019.rds")
deciler_landsdele <- deciler_landsdele %>% mutate(Landsdel = str_remove_all(string = Landsdel, pattern = "Landsdel")) %>% 
  arrange(desc(Landsdel))
deciler_landsdele
ggplotdata2 <- ggplotdata2 %>% mutate(Q10 = deciler_landsdele$Q10,
                                      Q50 = deciler_landsdele$Q50,
                                      Q90 = deciler_landsdele$Q90)
ggplotdata2
```


```{r}
ggplot(ggplotdata2$geometry, aes(fill = ggplotdata2$Q10)) +
  geom_sf() +
  theme_void() +
  labs(fill = "Q10") +
  theme(
  axis.text.x = element_blank(),
  axis.text.y = element_blank(),
  axis.ticks = element_blank())
```

```{r}
ggplot(ggplotdata2$geometry, aes(fill = ggplotdata2$Q50)) +
  geom_sf() +
  theme_void() +
  labs(fill = "Q50 - medianindkomst") +
  theme(
  axis.text.x = element_blank(),
  axis.text.y = element_blank(),
  axis.ticks = element_blank())
```

```{r}
ggplot(ggplotdata2$geometry, aes(fill = ggplotdata2$Q90)) +
  geom_sf() +
  theme_void() +
  labs(fill = "Q90") +
  theme(
  axis.text.x = element_blank(),
  axis.text.y = element_blank(),
  axis.ticks = element_blank())
```

## Q10, Q50, Q90 kommuner (IFOR22):
```{r}
ggplot(ggplotdata_komm, aes(fill = `1. decil`)) +
  geom_sf() +
  theme_void()
```

```{r}
ggplot(ggplotdata_komm, aes(fill = `5. decil`)) +
  geom_sf() +
  theme_void() +
  labs(fill = "Medianindkomst\n") +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    legend.title = element_text(size = 8),
    legend.text = element_text(size = 8),
    legend.margin = margin(r=2),
    legend.position = c(0.98, 0.55),
    plot.margin = unit(c(0,2,0,0), 'cm')) +
  scale_fill_gradient(low = 'grey93', high = 'orange')
```

```{r}
ggplot(ggplotdata_komm, aes(fill = `9. decil`)) +
  geom_sf() +
  theme_void() + 
  #scale_fill_viridis(option = "viridis", direction = 1, alpha = 0.75, begin = 0.15, end = 0.95, labels = scales::label_number()) +
  scale_fill_continuous(labels = scales::label_number()) #uden anden farve
```



# Brancher fordelinger (se Linear_regressions.Rmd) (LIGEAB4)

Nedre 1/3 
```{r}
brancher_nedre <- read_excel("Data/brancher_beskæftigede_landsdele_nedre.xlsx")
brancher_nedre <- brancher_nedre %>% mutate(Landsdel = str_remove_all(string = Landsdel, pattern = "Landsdel"),
                                            Prop = Sum/Total_beskæftigede) %>% 
  arrange(desc(Landsdel))
brancher_nedre
```


Midte:
```{r}
brancher_midte <- read_excel("Data/brancher_beskæftigede_landsdele_midte.xlsx")
brancher_midte <- brancher_midte %>% mutate(Landsdel = str_remove_all(string = Landsdel, pattern = "Landsdel"),
                                            Prop = Sum/Total_beskæftigede) %>% 
  arrange(desc(Landsdel))
brancher_midte
```

Øvre 1/3:
```{r}
brancher_top <- read_excel("Data/brancher_beskæftigede_landsdele_øvre.xlsx")
brancher_top <- brancher_top %>% mutate(Landsdel = str_remove_all(string = Landsdel, pattern = "Landsdel"),
                                            Prop = Sum/Total_beskæftigede) %>% 
  arrange(desc(Landsdel))
brancher_top
```

```{r}
ggplotdata2 <- ggplotdata2 %>% mutate(prop_i_brancher_nedre = brancher_nedre$Prop,
                                      prop_i_brancher_midte = brancher_midte$Prop,
                                      prop_i_brancher_top = brancher_top$Prop)
ggplotdata2
```

```{r}
ggplot(ggplotdata2$geometry, aes(fill = ggplotdata2$prop_i_brancher_nedre)) +
  geom_sf() +
  theme_void() +
  labs(fill = "Andel mænd i brancher med \nfærrest barselsdage\n") +
  scale_fill_viridis(option = "mako", direction = 1, alpha = 0.75, begin = 0.15, end = 0.95) +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    legend.title = element_text(size = 8),
    legend.text = element_text(size = 8),
    legend.margin = margin(r=2),
    legend.position = c(1.035, 0.55),
    plot.margin = unit(c(0,2,0,0), 'cm'))
```

```{r}
ggplot(ggplotdata2$geometry, aes(fill = ggplotdata2$prop_i_brancher_midte)) +
  geom_sf() +
  theme_void() +
  labs(fill = "Andel mænd i brancher med \ngennemsnitligt antal barselsdage\n") + 
  scale_fill_viridis(option = "mako", direction = 1, alpha = 0.75, begin = 0.15, end = 0.95) +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    legend.title = element_text(size = 8),
    legend.text = element_text(size = 8),
    legend.margin = margin(r=2),
    legend.position = c(1.045, 0.55),
    plot.margin = unit(c(0,2,0,0), 'cm'))
```

```{r}
ggplot(ggplotdata2$geometry, aes(fill = ggplotdata2$prop_i_brancher_top)) +
  geom_sf() +
  theme_void() +
  labs(fill = "Andel mænd i brancher med \nhøjt antal barselsdage\n") + 
  scale_fill_viridis(option = "mako", direction = 1, alpha = 0.75, begin = 0.15, end = 0.95) +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    legend.title = element_text(size = 8),
    legend.text = element_text(size = 8),
    legend.margin = margin(r=2),
    legend.position = c(1.035, 0.55),
    plot.margin = unit(c(0,2,0,0), 'cm'))
```

# Gennemsnitlig fødealder mænd og kvinder på landsdele

```{r}
fødealder_landsdel_2019 <- read_rds("Data/fødealder_landsdel_2019.rds")
fødealder_landsdel_2019 <- fødealder_landsdel_2019 %>% mutate(Landsdel = str_remove_all(string = Landsdel, pattern = "Landsdel")) %>% 
  arrange(desc(Landsdel))
ggplotdata2 <- ggplotdata2 %>% mutate(gns_førstefødte_mor = fødealder_landsdel_2019$gns_førstefødte_mor,
                                      gns_førstefødte_far = fødealder_landsdel_2019$gns_første_far)
ggplotdata2
```

```{r}
ggplot(ggplotdata2$geometry, aes(fill = ggplotdata2$gns_førstefødte_mor)) +
  geom_sf() +
  theme_void() +
  labs(fill = "Gennemsnitsalder ved førstefødte - mor  ") +
  theme(
  axis.text.x = element_blank(),
  axis.text.y = element_blank(),
  axis.ticks = element_blank())
```

```{r}
ggplot(ggplotdata2$geometry, aes(fill = ggplotdata2$gns_førstefødte_far)) +
  geom_sf() +
  theme_void() +
  labs(fill = "Gennemsnitsalder ved førstefødte - far  ") +
  theme(
  axis.text.x = element_blank(),
  axis.text.y = element_blank(),
  axis.ticks = element_blank())
```


## Gennemsnitlig fødealder mænd og kvinder, kommuner (FOD111):

```{r}
ggplot(ggplotdata_komm, aes(fill = `Gennemsnitsalder for førstegangsfødende kvinder`)) +
  geom_sf() + 
  theme_void() +
  labs(fill = 'Gennemsnitsalder førstegangsfødende -\nkvinder\n') +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    legend.title = element_text(size = 8),
    legend.text = element_text(size = 8),
    legend.margin = margin(r=2),
    legend.position = c(1.075, 0.55),
    plot.margin = unit(c(0,3,0,0), 'cm')) + 
  scale_fill_gradient(low = 'grey98', high = 'deeppink3')
```
```{r}
ggplot(ggplotdata_komm, aes(fill = `Gennemsnitsalder for førstegangs fædre`)) +
  geom_sf() + 
  theme_void() +
  labs(fill = 'Gennemsnitsalder førstegangsforælder -\nfar\n') +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    legend.title = element_text(size = 8),
    legend.text = element_text(size = 8),
    legend.margin = margin(r=2),
    legend.position = c(1.075, 0.55),
    plot.margin = unit(c(0,3,0,0), 'cm')) + 
  scale_fill_gradient(low = 'grey98', high = 'royalblue')
```

